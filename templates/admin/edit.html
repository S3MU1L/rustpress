{% extends "layouts/base.html" %}

{% block title %}Edit - {{ item.title }} - RustPress{% endblock %}

{% block header %}
{% include "partials/nav_admin.html" %}
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="mb-1">Edit {{ item.kind|capitalize }}</h1>
    <div class="flex items-center gap-2">
      <span class="badge">{{ item.kind }}</span>
      <span class="badge {% if item.status == "published" %}badge-success{% endif %}">{{ item.status }}</span>
    </div>
  </div>
  <div class="flex items-center gap-3">
    {% if item.kind == "post" %}
      <a class="btn-secondary" href="/blog/{{ item.slug }}" target="_blank">View Post</a>
    {% else %}
      <a class="btn-secondary" href="/{{ item.slug }}" target="_blank">View Page</a>
    {% endif %}
    <a class="btn-secondary" href="/admin">Back to Dashboard</a>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-6">
  <!-- Editor Form -->
  <div class="card p-5">
    <form id="edit-form" method="post" action="/admin/edit/{{ item.id }}" hx-post="/admin/edit/{{ item.id }}" hx-target="body" hx-swap="outerHTML">
      <label>
        Title
        <input id="title" name="title" value="{{ item.title }}" placeholder="Enter title..." />
      </label>

      <label>
        Slug
        <input id="slug" name="slug" value="{{ item.slug }}" placeholder="url-friendly-slug" />
      </label>

      <div class="grid grid-cols-2 gap-4">
        <label>
          Template
          <select name="template">
            {% for t in templates %}
              <option value="{{ t.name }}" {% if t.name == item.template %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Status
          <select name="status">
            <option value="draft" {% if item.status == "draft" %}selected{% endif %}>Draft</option>
            <option value="published" {% if item.status == "published" %}selected{% endif %}>Published</option>
          </select>
        </label>
      </div>

      <label>
        Content
        <div class="flex gap-1 mb-2 flex-wrap">
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<h2>Heading</h2>&#10;">H2</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<p>Paragraph text...</p>&#10;">P</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<a href='https://'>Link</a>">Link</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<img src='/static/' alt='' />">Image</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<pre><code>code</code></pre>&#10;">Code</button>
        </div>
        <textarea id="editor" name="content" rows="16">{{ item.content }}</textarea>
      </label>

      <div class="flex items-center gap-3 mt-4">
        <button class="btn-primary" type="submit">Save Changes</button>
        <button class="btn-primary" type="button" hx-post="/admin/publish/{{ item.id }}" hx-target="body" hx-swap="outerHTML">Publish</button>
      </div>

      <div
        id="autosave"
        class="text-rp-muted text-sm mt-3"
        hx-post="/admin/edit/{{ item.id }}/autosave"
        hx-trigger="input changed delay:1s from:#editor, input changed delay:1s from:#title, input changed delay:1s from:#slug, change delay:1s from:select[name='template']"
        hx-include="#edit-form"
        hx-target="this"
        hx-swap="innerHTML"
      ></div>
    </form>
  </div>

  <!-- Live Preview -->
  <div class="card p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg">Live Preview</h2>
      <span class="badge">Auto-updates</span>
    </div>
    <div
      id="preview"
      hx-post="/admin/edit/{{ item.id }}/preview"
      hx-trigger="load, input changed delay:450ms from:#editor, input changed delay:450ms from:#title, input changed delay:450ms from:#slug, change from:select[name='template']"
      hx-include="#edit-form"
      hx-target="this"
      hx-swap="innerHTML"
    >
      <p class="text-rp-muted">Loading preview...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const editor = document.getElementById('editor');
    if (!editor) return;
    document.querySelectorAll('[data-insert]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const text = btn.getAttribute('data-insert') || '';
        const start = editor.selectionStart || 0;
        const end = editor.selectionEnd || 0;
        const value = editor.value;
        editor.value = value.slice(0, start) + text + value.slice(end);
        const pos = start + text.length;
        editor.selectionStart = editor.selectionEnd = pos;
        editor.dispatchEvent(new Event('input', { bubbles: true }));
        editor.focus();
      });
    });
  })();
</script>
{% endblock %}
