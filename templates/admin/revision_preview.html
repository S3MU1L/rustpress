{% extends "layouts/base.html" %}
{% import "partials/content_macros.html" as macros %}

{% block title %}Revision #{{ revision.rev }} - {{ item.title }} - RustPress{% endblock %}

{% block header %}
{% include "partials/nav_admin.html" %}
{% endblock %}

{% block content %}
<!-- Revision preview banner -->
<div class="mb-4 p-3 rounded-lg bg-rp-warning/10 border border-rp-warning/20 text-sm flex items-center justify-between">
  <div class="flex items-center gap-2">
    {% if revision.rev > 1 %}
    <a href="/admin/edit/{{ item.id }}?rev={{ revision.rev - 1 }}"
      class="p-1 rounded hover:bg-rp-warning/20 text-rp-warning transition-colors" title="Previous revision">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </a>
    {% else %}
    <span class="p-1 text-rp-warning/30 cursor-not-allowed">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </span>
    {% endif %}
    <span class="text-rp-warning font-medium">
      Revision #{{ revision.rev }}
    </span>
    {% if revision.rev + 1 >= item.current_rev %}
    <a href="/admin/edit/{{ item.id }}" class="p-1 rounded hover:bg-rp-warning/20 text-rp-warning transition-colors"
      title="Return to current version">
      <span class="text-xs font-medium px-1">Current</span>
    </a>
    {% else %}
    <a href="/admin/edit/{{ item.id }}?rev={{ revision.rev + 1 }}"
      class="p-1 rounded hover:bg-rp-warning/20 text-rp-warning transition-colors" title="Next revision">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </a>
    {% endif %}
  </div>
  <div class="flex gap-2">
    <a href="/admin/edit/{{ item.id }}"
      class="px-3 py-1.5 rounded-lg bg-rp-border/50 hover:bg-rp-border text-rp-text text-sm transition-colors">
      Cancel
    </a>
    <button type="button"
      class="px-3 py-1.5 rounded-lg bg-rp-primary text-white text-sm font-medium hover:bg-rp-primary-hover transition-colors"
      hx-post="/admin/content/{{ item.id }}/revisions/{{ revision.rev }}/restore" hx-swap="none"
      hx-confirm="Restore to revision #{{ revision.rev }}? Current content will be replaced.">
      Restore this version
    </button>
  </div>
</div>

<!-- Header -->
<div class="mb-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      {{ macros::back_button() }}
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold text-rp-text">{{ revision.title }}</h1>
        <span class="text-rp-muted text-xs">(read-only)</span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <a class="px-4 py-2 rounded-lg bg-rp-primary text-white font-medium hover:bg-rp-primary-hover transition-colors text-sm inline-flex items-center gap-2"
        href="/admin/content/{{ item.id }}/preview?rev={{ revision.rev }}" target="_blank">
        {{ macros::preview_button() }}
        Preview
      </a>
      <button type="button" onclick="openVersionsModal()"
        class="px-4 py-2 rounded-lg bg-rp-surface border border-rp-border text-rp-text font-medium hover:bg-rp-border/30 transition-colors text-sm inline-flex items-center gap-2">
        {{ macros::clock_icon() }}
        Versions
      </button>
    </div>
  </div>

  <!-- Read-only metadata -->
  <div class="bg-rp-surface border border-rp-border rounded-lg p-4">
    <div class="flex flex-wrap items-center gap-4 text-sm">
      <div class="flex items-center gap-2">
        <span class="font-medium text-rp-text whitespace-nowrap">Slug:</span>
        <span class="text-rp-muted">{{ revision.slug }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="font-medium text-rp-text whitespace-nowrap">Template:</span>
        <span class="text-rp-muted">{{ revision.template }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="font-medium text-rp-text whitespace-nowrap">Status:</span>
        {% if revision.status.as_str() == "published" %}
        <span class="px-2 py-0.5 rounded-full text-xs bg-rp-secondary/10 text-rp-secondary">published</span>
        {% else %}
        <span class="px-2 py-0.5 rounded-full text-xs bg-rp-warning/10 text-rp-warning">{{ revision.status.as_str()
          }}</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="grid lg:grid-cols-[1fr_380px] gap-6">
  <!-- Main Editor Area (read-only) -->
  <div class="space-y-4">
    <!-- Content Editor (read-only) -->
    <div class="card p-0 overflow-hidden">
      {% include "partials/editor_readonly.html" %}
      <textarea id="editor" name="content" hidden>{{ revision.content }}</textarea>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-4">
    <!-- Preview -->
    <div class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium flex items-center gap-2">
          <svg class="w-4 h-4 text-rp-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          Preview
        </h3>
      </div>
      <div class="preview-wrapper relative cursor-pointer group" onclick="openPreviewModal()">
        <div
          class="absolute top-2 right-2 p-1.5 rounded-lg bg-black/50 text-white opacity-0 group-hover:opacity-100 z-10 pointer-events-none transition-opacity">
          {{ macros::expand_icon() }}
        </div>
        <div id="preview" class="border border-rp-border rounded-lg overflow-hidden bg-white">
          {{ preview_html|safe }}
        </div>
      </div>
    </div>

    <!-- Info -->
    <div class="card p-5">
      <h3 class="text-sm font-medium mb-3 flex items-center gap-2">
        <span class="text-rp-primary">{{ macros::info_icon() }}</span>
        Info
      </h3>
      <dl class="text-xs space-y-2">
        <div class="flex justify-between">
          <dt class="text-rp-muted">Author</dt>
          <dd>{{ revision_author }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-rp-muted">Created</dt>
          <dd>{{ revision.created_at.format("%b %d, %Y %H:%M") }}</dd>
        </div>
      </dl>
    </div>
  </div>
</div>

{% include "partials/preview_modal.html" %}

<!-- Versions Modal -->
<div id="versions-modal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/50" onclick="closeVersionsModal()"></div>
  <div class="absolute inset-y-0 right-0 w-full max-w-md bg-rp-bg border-l border-rp-border shadow-xl flex flex-col">
    <div class="flex items-center justify-between p-4 border-b border-rp-border">
      <h2 class="text-lg font-semibold flex items-center gap-2">
        <span class="text-rp-primary">{{ macros::clock_icon() }}</span>
        Version History
      </h2>
      <button type="button" onclick="closeVersionsModal()"
        class="p-1.5 rounded-lg text-rp-muted hover:text-rp-text hover:bg-rp-border/30 transition-colors">
        {{ macros::close_icon() }}
      </button>
    </div>
    <div id="versions-modal-body" class="flex-1 overflow-y-auto p-4">
      <p class="text-rp-muted text-sm">Loading...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Set editor to read-only mode -->
<script>
  window.EDITOR_READ_ONLY = true;
</script>

<!-- Include reusable editor scripts -->
{% include "partials/editor_scripts.html" %}

<script>
  const CONTENT_ITEM_ID = '{{ item.id }}';
  const CURRENT_REV = {{ item.current_rev }};
  const PREVIEW_REV = {{ revision.rev }};

  // Versions modal
  function openVersionsModal() {
    const modal = document.getElementById('versions-modal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    htmx.ajax('GET', `/admin/content/${CONTENT_ITEM_ID}/history`, '#versions-modal-body');
  }

  function closeVersionsModal() {
    document.getElementById('versions-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function (e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

    if (e.key === 'Escape') {
      // Close modals first, then navigate to edit page
      if (!document.getElementById('versions-modal').classList.contains('hidden')) {
        closeVersionsModal();
      } else if (!document.getElementById('preview-modal').classList.contains('hidden')) {
        closePreviewModal();
      } else {
        window.location.href = `/admin/edit/${CONTENT_ITEM_ID}`;
      }
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      if (PREVIEW_REV > 1) {
        window.location.href = `/admin/edit/${CONTENT_ITEM_ID}?rev=${PREVIEW_REV - 1}`;
      }
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      if (PREVIEW_REV + 1 >= CURRENT_REV) {
        window.location.href = `/admin/edit/${CONTENT_ITEM_ID}`;
      } else {
        window.location.href = `/admin/edit/${CONTENT_ITEM_ID}?rev=${PREVIEW_REV + 1}`;
      }
    }
  });
</script>
{% endblock %}