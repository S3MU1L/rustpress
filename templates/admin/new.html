{% extends "layouts/base.html" %}

{% block title %}New {{ kind }} - RustPress{% endblock %}

{% block header %}
<header class="sticky top-0 bg-rp-card/85 backdrop-blur-sm border-b border-rp-border">
  <div class="max-w-5xl mx-auto px-6 py-3.5 flex items-center justify-between">
    <a class="font-bold text-rp-text hover:no-underline" href="/admin">Admin</a>
    <nav class="flex gap-3.5">
      <a class="text-rp-muted hover:text-rp-text" href="/admin/sites">Sites</a>
      <a class="text-rp-muted hover:text-rp-text" href="/admin/themes">Themes</a>
      <a class="text-rp-muted hover:text-rp-text" href="/">View site</a>
    </nav>
  </div>
</header>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">New {{ kind }}</h1>

<div class="grid lg:grid-cols-2 gap-4 items-start">
  <form id="new-form" class="bg-rp-card/90 border border-rp-border rounded-xl p-4" method="post" action="/admin/{{ kind }}" hx-post="/admin/{{ kind }}" hx-trigger="submit" hx-swap="none">
    <input type="hidden" name="kind" value="{{ kind }}" />

    <label>Title
      <input id="title" name="title" required />
    </label>

    <label>Slug
      <input id="slug" name="slug" required placeholder="hello-world" />
    </label>

    <label>Template
      <select name="template">
        {% for t in templates %}
          <option value="{{ t.name }}" {% if t.name == default_template %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
    </label>

    <div class="flex gap-2 flex-wrap mt-1.5">
      <button class="px-2 py-1 text-xs rounded border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105" type="button" data-insert="<h1>Your title</h1>&#10;">H1</button>
      <button class="px-2 py-1 text-xs rounded border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105" type="button" data-insert="<h2>Section</h2>&#10;">H2</button>
      <button class="px-2 py-1 text-xs rounded border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105" type="button" data-insert="<p>Paragraph…</p>&#10;">P</button>
      <button class="px-2 py-1 text-xs rounded border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105" type="button" data-insert="<a href='https://example.com' target='_blank' rel='noopener noreferrer'>Link</a>">Link</button>
      <button class="px-2 py-1 text-xs rounded border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105" type="button" data-insert="<img src='/static/your-image.png' alt='' />">Image</button>
      <button class="px-2 py-1 text-xs rounded border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105" type="button" data-insert="<pre><code>// code</code></pre>&#10;">Code</button>
    </div>

    <label>Content
      <textarea id="editor" name="content" rows="14" placeholder="Write something..."></textarea>
    </label>

    <div class="flex gap-2.5 flex-wrap mt-3.5">
      <button class="inline-block px-3.5 py-2.5 rounded-lg border border-rp-border bg-gradient-to-b from-[#1b2b5c] to-[#13214b] text-rp-text cursor-pointer hover:brightness-105" type="submit">Create draft</button>
      <a class="inline-block px-3.5 py-2.5 rounded-lg border border-rp-border bg-transparent text-rp-muted cursor-pointer hover:brightness-105 hover:no-underline" href="/admin">Cancel</a>
    </div>
  </form>

  <div class="bg-rp-card/90 border border-rp-border rounded-xl p-4">
    <div class="flex items-center gap-2.5 justify-between mb-2.5">
      <h2 class="text-lg font-semibold">Live preview</h2>
      <span class="text-xs px-2 py-0.5 border border-rp-border rounded-full text-rp-muted">HTMX</span>
    </div>
    <div
      id="preview"
      hx-post="/admin/preview"
      hx-trigger="load, input changed delay:450ms from:#editor, input changed delay:450ms from:#title, input changed delay:450ms from:#slug, change from:select[name='template']"
      hx-include="#new-form"
      hx-target="this"
      hx-swap="innerHTML"
    >
      <p class="text-rp-muted">Loading preview…</p>
    </div>
    <p class="text-rp-muted text-sm mt-2">Tip: preview updates as you type; create saves a draft.</p>
  </div>
</div>

<p class="text-rp-muted text-sm mt-3">HTMX is enabled; on success you'll be redirected to the editor.</p>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const editor = document.getElementById('editor');
    if (!editor) return;
    document.querySelectorAll('[data-insert]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const text = btn.getAttribute('data-insert') || '';
        const start = editor.selectionStart || 0;
        const end = editor.selectionEnd || 0;
        const value = editor.value;
        editor.value = value.slice(0, start) + text + value.slice(end);
        const pos = start + text.length;
        editor.selectionStart = editor.selectionEnd = pos;
        editor.dispatchEvent(new Event('input', { bubbles: true }));
        editor.focus();
      });
    });
  })();
</script>
{% endblock %}
