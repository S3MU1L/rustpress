{% extends "layouts/base.html" %}

{% block title %}New {{ kind }} - RustPress{% endblock %}

{% block header %}
{% include "partials/nav_admin.html" %}
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="mb-1">New {{ kind|capitalize }}</h1>
    <p class="text-rp-muted">Create a new {{ kind }} for your site.</p>
  </div>
  <a class="btn-secondary" href="/admin">Cancel</a>
</div>

<div class="grid lg:grid-cols-2 gap-6">
  <!-- Editor Form -->
  <div class="card p-5">
    <form id="new-form" method="post" action="/admin/{{ kind }}" hx-post="/admin/{{ kind }}" hx-trigger="submit" hx-swap="none">
      <input type="hidden" name="kind" value="{{ kind }}" />

      <label>
        Title
        <input id="title" name="title" required placeholder="Enter title..." />
      </label>

      <label>
        Slug
        <input id="slug" name="slug" required placeholder="url-friendly-slug" />
      </label>

      <label>
        Template
        <select name="template">
          {% for t in templates %}
            <option value="{{ t.name }}" {% if t.name == default_template %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        Content
        <div class="flex gap-1 mb-2 flex-wrap">
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<h2>Heading</h2>&#10;">H2</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<p>Paragraph text...</p>&#10;">P</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<a href='https://'>Link</a>">Link</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<img src='/static/' alt='' />">Image</button>
          <button class="px-2 py-1 text-xs rounded bg-rp-bg border border-rp-border text-rp-muted cursor-pointer hover:bg-rp-border/50" type="button" data-insert="<pre><code>code</code></pre>&#10;">Code</button>
        </div>
        <textarea id="editor" name="content" rows="14" placeholder="Write your content here..."></textarea>
      </label>

      <div class="flex items-center gap-3 mt-4">
        <button class="btn-primary" type="submit">Create Draft</button>
      </div>
    </form>
  </div>

  <!-- Live Preview -->
  <div class="card p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg">Live Preview</h2>
      <span class="badge">Auto-updates</span>
    </div>
    <div
      id="preview"
      hx-post="/admin/preview"
      hx-trigger="load, input changed delay:450ms from:#editor, input changed delay:450ms from:#title, input changed delay:450ms from:#slug, change from:select[name='template']"
      hx-include="#new-form"
      hx-target="this"
      hx-swap="innerHTML"
    >
      <p class="text-rp-muted">Loading preview...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const editor = document.getElementById('editor');
    if (!editor) return;
    document.querySelectorAll('[data-insert]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const text = btn.getAttribute('data-insert') || '';
        const start = editor.selectionStart || 0;
        const end = editor.selectionEnd || 0;
        const value = editor.value;
        editor.value = value.slice(0, start) + text + value.slice(end);
        const pos = start + text.length;
        editor.selectionStart = editor.selectionEnd = pos;
        editor.dispatchEvent(new Event('input', { bubbles: true }));
        editor.focus();
      });
    });
  })();
</script>
{% endblock %}
